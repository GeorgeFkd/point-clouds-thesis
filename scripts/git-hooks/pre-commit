#!/bin/bash

#generated by claude code

# Pre-commit hook to check and format changed C/C++ files
# Place this file in .git/hooks/pre-commit and make it executable

# Get list of staged C/C++ files
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|cc|cxx|h|hpp|hxx)$')

if [ -z "$FILES" ]; then
    # No C/C++ files staged, exit successfully
    exit 0
fi

# Check if clang-format is installed
if ! command -v clang-format &> /dev/null; then
    echo "‚ùå Error: clang-format is not installed."
    echo "Please install it before committing."
    echo ""
    echo "On Ubuntu/Debian: sudo apt install clang-format"
    echo "On macOS: brew install clang-format"
    exit 1
fi

echo "üîç Checking formatting for staged files..."

# Check each file for formatting issues
UNFORMATTED=""
for FILE in $FILES; do
    # Check if file needs formatting
    clang-format --dry-run --Werror "$FILE" 2>&1 > /dev/null
    if [ $? -ne 0 ]; then
        UNFORMATTED="$UNFORMATTED $FILE"
    fi
done

# If there are unformatted files, format them and abort the commit
if [ -n "$UNFORMATTED" ]; then
    echo ""
    echo "‚ùå The following files are not formatted correctly:"
    for FILE in $UNFORMATTED; do
        echo "   - $FILE"
    done
    echo ""
    echo "üîß Formatting files now..."
    
    # Format each unformatted file
    for FILE in $UNFORMATTED; do
        clang-format -i "$FILE"
        echo "   ‚úì Formatted: $FILE"
    done
    
    echo ""
    echo "Files have been formatted!"
    echo ""
    echo "Review the changes, stage them, and commit again:"
    echo ""
    exit 1
fi

echo "‚úÖ All staged files are properly formatted!"
exit 0
